services:
  # ── OAuth2-Proxy (auth entry point) ──────────────────────────
  # All browser traffic enters here at localhost:4180.
  # Authenticates via B2C, then proxies to Portal with JWT header.
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.7.1
    ports:
      - "4180:4180"
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL=${B2C_OIDC_ISSUER_URL}
      - OAUTH2_PROXY_CLIENT_ID=${OAUTH2_PROXY_CLIENT_ID}
      - OAUTH2_PROXY_CLIENT_SECRET=${OAUTH2_PROXY_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECRET=${OAUTH2_PROXY_COOKIE_SECRET}
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_UPSTREAMS=http://portal:3000
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_REDIRECT_URL=http://localhost:4180/oauth2/callback
      - OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
      # B2C requires scope in the token exchange POST body to issue an access_token.
      # The Go oauth2 library doesn't send it, so we proxy through token-proxy.
      - OAUTH2_PROXY_SCOPE=openid offline_access ${B2C_API_SCOPE}
      - OAUTH2_PROXY_REDEEM_URL=http://token-proxy:8888${B2C_TOKEN_ENDPOINT_PATH}
      # B2C uses "emails" (array) instead of standard "email" (string) claim.
      - OAUTH2_PROXY_OIDC_EMAIL_CLAIM=emails
      # B2C does not return an email_verified claim — allow unverified emails.
      - OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL=true
    depends_on:
      - portal
      - token-proxy
    networks:
      - portal-net

  # ── Portal (Next.js 14 — UI + API Routes) ────────────────────
  portal:
    build:
      context: ./portal
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./portal/src:/app/src
      - ./portal/public:/app/public
      - ./shared/ts:/app/shared
    environment:
      - NEXT_PUBLIC_ENV=development
      - B2C_TENANT_ID=${B2C_TENANT_ID:-}
      - B2C_GRAPH_CLIENT_ID=${B2C_GRAPH_CLIENT_ID:-}
      - B2C_GRAPH_CLIENT_SECRET=${B2C_GRAPH_CLIENT_SECRET:-}
      - ADMIN_AGENT_URL=http://admin-agent:8080
      - ADMIN_AGENT_SECRET=${ADMIN_AGENT_SECRET:-dev-secret}
    networks:
      - portal-net

  # ── Admin Agent (Hono + dockerode) ───────────────────────────
  # Internal only — not exposed to host. Portal calls via portal-net.
  admin-agent:
    build:
      context: ./admin-agent
      dockerfile: Dockerfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./admin-agent/src:/app/src
    environment:
      - ADMIN_AGENT_SECRET=${ADMIN_AGENT_SECRET:-dev-secret}
      - PORT=8080
    networks:
      - portal-net

  # ── Token Proxy (B2C scope fix) ─────────────────────────────
  # Works around Go oauth2 library not sending scope in token exchange.
  # Intercepts token requests, adds scope, forwards to B2C.
  token-proxy:
    image: node:20-alpine
    command: node /app/proxy.js
    volumes:
      - ./token-proxy/proxy.js:/app/proxy.js:ro
    environment:
      - B2C_API_SCOPE=${B2C_API_SCOPE}
      - B2C_TOKEN_HOST=${B2C_TOKEN_HOST:-teamhitorib2c.b2clogin.com}
      - PORT=8888
    networks:
      - portal-net

networks:
  portal-net:
    driver: bridge
