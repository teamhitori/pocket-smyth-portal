# Azure AD B2C — Attributes & Custom Attributes

How B2C stores user data, and how pocket-smyth-portal uses custom attributes for application state.

---

## Built-in vs. Custom Attributes

Azure AD B2C stores user data as **attributes** on user objects in the directory.

### Built-in Attributes

These are standard directory properties that exist for every user:

| Attribute | Type | Example | Source |
|-----------|------|---------|--------|
| `displayName` | String | "Reuben Smith" | Collected at sign-up or from IdP |
| `givenName` | String | "Reuben" | Collected at sign-up or from IdP |
| `surname` | String | "Smith" | Collected at sign-up or from IdP |
| `mail` | String | "reuben@example.com" | From IdP (read-only for social users) |
| `objectId` | GUID | `aaaa-bbbb-cccc-...` | System-generated, immutable |
| `accountEnabled` | Boolean | `true` | System-managed |
| `createdDateTime` | DateTime | `2025-02-15T10:00:00Z` | System-generated |
| `userPrincipalName` | String | `cpim_aaaa...@tenant.onmicrosoft.com` | System-generated (B2C internal format) |
| `identities` | Array | Social IdP links | System-managed |

> **Note:** For social sign-in users, `userPrincipalName` is auto-generated by B2C in an internal format (prefixed with `cpim_`). It's not meaningful — use `objectId` as the unique identifier.

### Custom Attributes (Extension Properties)

Custom attributes let you extend the user object with application-specific data. B2C supports up to **100 custom attributes** per user.

Custom attributes are also called:
- **Extension properties** (Microsoft Graph terminology)
- **Extension attributes** (directory terminology)
- **Custom claims** (when they appear in tokens)

All three terms mean the same thing.

---

## Our Custom Attributes

pocket-smyth-portal defines four custom attributes:

| Attribute | Data Type | Possible Values | Purpose |
|-----------|-----------|----------------|---------|
| **Status** | String | `pending`, `approved`, `active`, `revoked` | User lifecycle state |
| **Role** | String | `user`, `admin` | Authorization level |
| **Username** | String | e.g., `reuben`, `alice` | Subdomain for user's portal (`{username}.teamhitori.com`) |
| **ContainerPort** | Int | e.g., `10001`, `10002` | Port mapped to user's Agent Zero container |

### Lifecycle Flow

```
User signs up via B2C
    │
    ▼
Status = "pending"     ← Default, set by Graph API on first sign-in detection
Role = "user"          ← Default
Username = (empty)     ← Not yet assigned
ContainerPort = (empty)← Not yet assigned
    │
    ▼
Admin approves user
    │
    ▼
Status = "approved"    ← Set by admin via portal
Username = "reuben"    ← Assigned by admin
    │
    ▼
Container provisioned
    │
    ▼
Status = "active"      ← Set after container is running
ContainerPort = 10001  ← Assigned by Admin Agent
    │
    ▼
Admin revokes user (if needed)
    │
    ▼
Status = "revoked"     ← Container stopped, access blocked
```

---

## Creating Custom Attributes

### In the Azure Portal

1. Azure Portal → **Azure AD B2C** → **User attributes**
2. Click **Add**
3. For each attribute:

| Name | Data Type |
|------|-----------|
| `Status` | String |
| `Role` | String |
| `Username` | String |
| `ContainerPort` | Int |

4. Click **Create** for each

> **Important:** Creating a custom attribute in "User attributes" only registers it in the directory. It does NOT automatically collect it during sign-up or include it in tokens. You must configure that separately in the user flow.

### Adding to a User Flow

1. Go to **User flows** → select your flow
2. Click **User attributes** (what to collect during sign-up)
   - Do NOT check Status, Role, Username, or ContainerPort (these are set server-side)
3. Click **Application claims** (what to return in the token)
   - ✅ Check Status and Role (portal needs these to determine access)
   - ✅ Check Username (portal needs this for subdomain routing)
   - ❌ Do not check ContainerPort (internal use only)
4. Click **Save**

---

## How Custom Attributes Are Stored

### The b2c-extensions-app

Custom attributes are stored as **directory extensions** on a special application called `b2c-extensions-app`. This app is auto-created when the B2C tenant is set up.

```
App registrations → All applications → 
"b2c-extensions-app. Do not modify. Used by AADB2C for storing user data."
```

The app's **Application (client) ID** (without hyphens) forms the extension attribute prefix.

### Extension Attribute Naming Convention

```
extension_{appId-without-hyphens}_{attributeName}
```

For our tenant:

| Attribute | Internal Name |
|-----------|--------------|
| Status | `extension_3575970a911e4699ad1ccc1a507d2312_Status` |
| Role | `extension_3575970a911e4699ad1ccc1a507d2312_Role` |
| Username | `extension_3575970a911e4699ad1ccc1a507d2312_Username` |
| ContainerPort | `extension_3575970a911e4699ad1ccc1a507d2312_ContainerPort` |

This naming convention applies everywhere:
- In Microsoft Graph API requests/responses
- In B2C token claims (when returned as application claims)
- In B2C portal (shown as the short name, but stored with the full prefix)

### In Code

The prefix is defined in `shared/ts/types.ts`:

```typescript
export const B2C_EXT_PREFIX = 'extension_3575970a911e4699ad1ccc1a507d2312_';
```

When reading claims from a token:

```typescript
const status = claims[`${B2C_EXT_PREFIX}Status`]; // "pending" | "approved" | "active" | "revoked"
const role = claims[`${B2C_EXT_PREFIX}Role`];     // "user" | "admin"
const username = claims[`${B2C_EXT_PREFIX}Username`]; // "reuben" or undefined
```

---

## Reading and Writing Attributes via Graph API

Custom attributes are read and written using the **Microsoft Graph API** with the Graph API app registration (Client Credentials flow).

### Reading a User's Attributes

```http
GET https://graph.microsoft.com/v1.0/users/{objectId}
  ?$select=id,displayName,givenName,surname,mail,
           extension_3575970a911e4699ad1ccc1a507d2312_Status,
           extension_3575970a911e4699ad1ccc1a507d2312_Role,
           extension_3575970a911e4699ad1ccc1a507d2312_Username,
           extension_3575970a911e4699ad1ccc1a507d2312_ContainerPort

Authorization: Bearer {graph-access-token}
```

Response:
```json
{
  "id": "aaaa-bbbb-cccc-...",
  "displayName": "Reuben Smith",
  "givenName": "Reuben",
  "surname": "Smith",
  "extension_3575970a911e4699ad1ccc1a507d2312_Status": "pending",
  "extension_3575970a911e4699ad1ccc1a507d2312_Role": "user",
  "extension_3575970a911e4699ad1ccc1a507d2312_Username": null,
  "extension_3575970a911e4699ad1ccc1a507d2312_ContainerPort": null
}
```

### Writing Attributes (Approve a User)

```http
PATCH https://graph.microsoft.com/v1.0/users/{objectId}

Authorization: Bearer {graph-access-token}
Content-Type: application/json

{
  "extension_3575970a911e4699ad1ccc1a507d2312_Status": "approved",
  "extension_3575970a911e4699ad1ccc1a507d2312_Username": "reuben"
}
```

### Listing All Users with Custom Attributes

```http
GET https://graph.microsoft.com/v1.0/users
  ?$select=id,displayName,mail,
           extension_3575970a911e4699ad1ccc1a507d2312_Status,
           extension_3575970a911e4699ad1ccc1a507d2312_Role,
           extension_3575970a911e4699ad1ccc1a507d2312_Username
  &$filter=extension_3575970a911e4699ad1ccc1a507d2312_Status eq 'pending'

Authorization: Bearer {graph-access-token}
```

### Getting a Graph API Access Token

The Portal uses the **Client Credentials** flow (no user interaction):

```http
POST https://login.microsoftonline.com/359dc45f-49b6-4472-92f1-092556a84a98/oauth2/v2.0/token

grant_type=client_credentials
&client_id=6c50fb10-e1d2-4ca7-be00-6cb29b7f474b
&client_secret={B2C_GRAPH_CLIENT_SECRET}
&scope=https://graph.microsoft.com/.default
```

> **Note:** The token endpoint for Client Credentials uses `login.microsoftonline.com`, not `b2clogin.com`. This is because Graph API access goes through the standard Microsoft identity platform, not the B2C-specific endpoint.

---

## Attributes in Tokens vs. Graph API

| Context | Attribute Names | Example |
|---------|----------------|---------|
| **In tokens** (claims) | Full extension name | `extension_3575970a911e4699ad1ccc1a507d2312_Status` |
| **In Graph API** | Full extension name | `extension_3575970a911e4699ad1ccc1a507d2312_Status` |
| **In B2C Portal UI** | Short name | `Status` |
| **In user flow config** | Short name | `Status` |

The full extension name is used consistently in tokens and Graph API. Only the B2C portal UI shows the short name.

---

## Data Type Constraints

| Data Type | Graph Type | Allowed Values |
|-----------|-----------|----------------|
| **String** | `Edm.String` | Up to 256 characters |
| **Boolean** | `Edm.Boolean` | `true` or `false` |
| **Int** | `Edm.Int32` | 32-bit integer |

B2C custom attributes only support these three types. For more complex data, use String and serialize JSON (not recommended).

---

## Which Attributes to Collect vs. Set Server-Side

| Attribute | Collect at Sign-up? | Set Server-Side? | Why |
|-----------|--------------------|--------------------|-----|
| Display Name | ✅ Yes | ❌ | User provides during sign-up |
| Given Name | ✅ Yes | ❌ | User provides during sign-up |
| Surname | ✅ Yes | ❌ | User provides during sign-up |
| Email | ❌ (from IdP) | ❌ | Automatically from social IdP |
| Status | ❌ | ✅ Graph API | Security — users shouldn't set their own status |
| Role | ❌ | ✅ Graph API | Security — users shouldn't set their own role |
| Username | ❌ | ✅ Graph API | Assigned by admin after approval |
| ContainerPort | ❌ | ✅ Graph API | Assigned by system during provisioning |

> **Security principle:** Never let users set attributes that control authorization (Status, Role). These must be set server-side through the Graph API with proper admin authentication.

---

## Removing a Custom Attribute

1. First, clear the value for all users (set to `null` via Graph API)
2. Remove from all user flows (User attributes and Application claims)
3. Go to **User attributes** → select the attribute → **Delete**

> ⚠️ **Warning:** Deleting a custom attribute is permanent. Clear values first to avoid orphaned data.

---

## Further Reading

- [Define custom attributes in Azure AD B2C](https://learn.microsoft.com/en-us/azure/active-directory-b2c/user-flow-custom-attributes)
- [User profile attributes in Azure AD B2C](https://learn.microsoft.com/en-us/azure/active-directory-b2c/user-profile-attributes)
- [Manage Azure AD B2C with Microsoft Graph](https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-operations)
- [Application extension (directory extension) properties](https://learn.microsoft.com/en-us/azure/active-directory-b2c/microsoft-graph-operations#application-extension-directory-extension-properties)
